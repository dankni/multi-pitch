<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <!-- Styles -->
    <link href="../website/css/style.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Roboto:300" rel="stylesheet" />
    <!-- Scripts-->
    <script src="../website/data/data.js"></script>
    <script>
        /* block render for these */
        var img = new Image();
        var flag = new Image();
        var logo = new Image();
        logo.src = '../website/img/logo/mp-logo-white.png';

        img.src = 'tenerife/la-catedral.jpg';
        flag.src = 'flags/es.png';
        var climbTitle = 'Cathedral Rock > Via Mendez & Guillermo | VS 4c - 115m';
        var route = new Array(
            [998, 2160], [927, 1853], [880, 1615], [812, 1540], [735, 1460], [905, 1372], [927, 1262], [1035, 1197], [1117, 810], [1107, 658], [1122, 552], [1097, 405], [1158, 365], [1147, 227]
        );
        var belays = new Array(
            [755, 1468], [1117, 799]
        );
        var absail = new Array(
            [1150.0, 224.7, 1095.0, 338.7], [1120.0, 798.0, 1053.0, 837.0], [652.0, 1115.0, 625.0, 1273.0]
        );
       
        function printOutput() {
            var rawOutput = document.getElementById('rawOutput');
            rawOutput.innerHTML += "flag.src = '" + flag.src + "';<br />";
            rawOutput.innerHTML += "var climbTitle = '" + climbTitle + "';<br />";
            rawOutput.innerHTML += "var route = new Array( <br />";
            for (let i = 0; i < route.length; i++) {
                rawOutput.innerHTML += "[" + route[i][0] + ", " + route[i][1] + "]";
                if (i < route.length - 1) {
                    rawOutput.innerHTML += ",";
                } else {
                    rawOutput.innerHTML += "<br />";
                }
            }
            rawOutput.innerHTML += "); <br />"
            rawOutput.innerHTML += "var belays = new Array( <br />";
            for (let i = 0; i < belays.length; i++) {
                rawOutput.innerHTML += "[" + belays[i][0] + ", " + belays[i][1] + "]";
                if (i < belays.length - 1) {
                    rawOutput.innerHTML += ",";
                } else {
                    rawOutput.innerHTML += "<br />";
                }
            }
            rawOutput.innerHTML += "); <br />"
            rawOutput.innerHTML += "var absail = new Array( <br />";
            for (let i = 0; i < absail.length; i++) {
                rawOutput.innerHTML += "[" + absail[i][0] + ", " + absail[i][2] + ", " + absail[i][3] + ", " + absail[i][1] + "]";
                if (i < absail.length - 1) {
                    rawOutput.innerHTML += ",";
                } else {
                    rawOutput.innerHTML += "<br />";
                }
            }
            rawOutput.innerHTML += "); <br />"
        }
    </script>
    <style>
        *, option {
            font-size: 55px;
        }
        label {
            margin-right:60px;
        }
    </style>
</head>
<body>
    <canvas id="canvas" width="2800" height="2800"></canvas>

    <section style="width:100%;margin:0 auto; padding:100px;">
        <h1>Build A Topo</h1>
        <p>Use this tool to make consistent topo images for the site or for social media.</p>
        <fieldset>
            <label><input type="checkbox" value="infoBox" checked id="c1" />Show Info Box</label>
            <label><input type="checkbox" value="routeLine" checked id="c2" />Show Route</label>
            <label><input type="checkbox" value="belays" checked id="c3" />Show Belay Points</label>
            <label><input type="checkbox" value="absail" checked id="c4" />Show Approch / Decent Absails</label>
        </fieldset>
        <br />
        <fieldset>
            <label><input type="radio" value="max" checked name="scale" />Maximum size</label>
            <label><input type="radio" value="2880" name="scale" />Big 2880w</label>
            <label><input type="radio" value="1920" name="scale" />Medium  1920w</label>
            <label><input type="radio" value="900" name="scale" />Small 900w</label>
        </fieldset>
        <br />
        <button onclick="draw()">Re-Draw Topo</button>
        <br />

        <h2>Step 1 - Select Climb</h2>
        <p>Add the crag image into the scource code then select what climb it is for.</p>
        <fieldset id="selectHolder"></fieldset>
        <h2>Step 2 - Click the map to choose the route</h2>
        <p>
            Press the start button. click the image to along where the route would be. Remember you need to re-draw the canvas
            to see the points you selected. See browser console for actual numbers selected.
        </p>
        <button onclick="capture('route')">Start</button>
        <h2>Step 3 - Click the map to choose the beleys</h2>
        <p>
            Press the start button. Click the image at the appropriate belay points.
            Remember you need to re-draw the canvas to see the points you selected. See browser console for actual numbers selected.
        </p>
        <button onclick="capture('belay')">Start</button>
        <h2>Step 4 - Click the map to choose the absails</h2>
        <p>
            For an absail you need to click the start of the absail anchor,
            then click again in the direction the absail goes. if there are 3
            absails that means 6 clicks.
        </p>
        <button onclick="capture('absail')">Start</button>
        <br />
        <hr />
        <br />
        <h2>Step 5 - get the output</h2>
        <button onClick="printOutput()">Print Output</button>
        <fieldset>
            <pre id="rawOutput"></pre>
        </fieldset>

    </section>
    <br />
    <br />
    <script>
        /** MAKE A DROP DOWN WITH A LIST OF ALL CLIMBS **/
        var selectHolder = document.getElementById("selectHolder");
        var selectList = document.createElement("select");
        const climbsArr = climbsData.climbs;
        selectList.setAttribute("id", "climbList");
        selectList.setAttribute("name", "climbList");
        selectHolder.appendChild(selectList);
        for (let i = 0; i < climbsArr.length; i++) {
            var option = document.createElement("option");
            option.setAttribute("value", climbsArr[i].id);
            option.text = climbsArr[i].cliff;
            selectList.appendChild(option);
        }

        /** BUILDER STEP 1 - GET CLIMB DETAILS **/
        document.addEventListener('DOMContentLoaded', function () {
            document.querySelector('select[name="climbList"]').onchange = changeEventHandler;
        }, false);
        var mapping = {
            'england': 'gb.png', 'scotland': 'gb.png', 'wales': 'gb.png', 'ireland': 'ie.png', 'spain': 'es.png', 'portugal': 'pt.png',
            'italy': 'it.png', 'usa': 'us.png', 'norway': 'no.png', 'canada': 'ca.png', 'hongkong': 'cn.png', 'greece': 'gr.png',
            'france': 'fr.png', 'switzerland': 'ch.png'
        }; // base 64 images from the css as vectors on canvas don't play nice :(
        function changeEventHandler(event) {
            if (event.target.value) {
                var climb = climbsArr.find(climb => climb.id == event.target.value); // get the single climb object
                flag.src = 'flags/' + mapping[climb.flag];
                climbTitle = climb.cliff + " > " + climb.routeName + " | " + climb.tradGrade + " " + climb.techGrade + " - " + climb.length + "m";
            }

        }

        /** GLOBAL VARIABLES / DATA **/
        const canvas = document.getElementById('canvas');
        var scale;
        var maxWidth;
        var arrayToUpdate;
        var tempAbsail = [];
        const lineColor = "rgba(204,25,29,0.95)";
        const belayColor = "rgb(236,142,140,0.9)";
        const decentBelay = "rgba(218,112,214,0.9)";
        const decentLine = "rgb(153,50,204,0.95)";
        const infoBoxColor = 'rgba(28, 35, 49, 0.95)';

        function draw() {
            /** DEFINE THE DERIVED DRAWING VARIABLES */
            let infoBox = document.getElementById('c1').checked; 
            let routeLine = document.getElementById('c2').checked; 
            let belayPoints = document.getElementById('c3').checked; 
            let absailPoints = document.getElementById('c4').checked; 
            var ctx = document.getElementById('canvas').getContext('2d');
            let scaleRadio = document.getElementsByName("scale");
            for (let i = 0; i < scaleRadio.length; i++) {
                if (scaleRadio[i].checked) {
                    maxWidth = scaleRadio[i].value;
                }
            }
            maxWidth !== 'max' && maxWidth < img.width ? scale = maxWidth / img.width : scale = 1; 
            const imgWidth = sThis(img.width);
            const imgHeight = sThis(img.height);
            const belaySize = sThis(24);
            const flagWidth = sThis(100);
            const flagLeftMargin = sThis(80);
            const flagHeight = flagWidth * (flag.height / flag.width);
            const arrowSize = sThis(24);
            const boxHeight = sThis(100);
            const fontsize = sThis(55);
            const lineWidth = sThis(6);
            canvas.width = imgWidth;
            canvas.height = imgHeight;


            // Adds the main Crag image
            ctx.drawImage(img, 0, 0, imgWidth, imgHeight);

            // Ads the box at the bottom
            if (infoBox === true) {
                ctx.fillStyle = infoBoxColor;
                ctx.rect(0, imgHeight - boxHeight, imgWidth, imgHeight); // ToDo: make sizes relative to image size eg 8% of height
                ctx.fill();
                ctx.drawImage(flag, flagLeftMargin, (imgHeight - boxHeight + ((boxHeight - flagHeight) / 2)), flagWidth, flagHeight);
                ctx.drawImage(logo, (imgWidth - sThis(520)), (imgHeight - sThis(90)), sThis(75), sThis(75));
                ctx.font = fontsize + "px sans-serif";
                ctx.fillStyle = "#ffffff";
                ctx.fillText(climbTitle, flagLeftMargin * 2 + flagWidth, imgHeight - sThis(35));
                ctx.fillText('multi-pitch.com', (imgWidth - sThis(420)), imgHeight - sThis(35));
            }

            // Add the Topo Line
            if (routeLine === true) {
                ctx.beginPath();
                ctx.moveTo(sThis(route[0][0]), sThis(route[0][1]));
                for (var i = 1; i < route.length - 2; i++) {
                    var c = sThis((route[i][0] + route[i + 1][0]) / 2);
                    var d = sThis((route[i][1] + route[i + 1][1]) / 2);

                    ctx.quadraticCurveTo(sThis(route[i][0]), sThis(route[i][1]), c, d); // this makes the lines smooth
                }
                ctx.quadraticCurveTo(sThis(route[i][0]), sThis(route[i][1]), sThis(route[i + 1][0]), sThis(route[i + 1][1])); // For the last 2 points
                ctx.strokeStyle = lineColor;
                ctx.setLineDash([32, 8, 5, 8]);
                ctx.lineWidth = lineWidth;
                ctx.lineCap = 'round';
                ctx.stroke();
            }

            // Add the Belay Points
            if (belayPoints === true) {
                ctx.strokeStyle = lineColor;
                ctx.setLineDash([]);
                ctx.lineWidth = lineWidth;
                ctx.fillStyle = belayColor;
                for (let i = 0; i < belays.length; i++) {
                    ctx.beginPath();
                    ctx.arc(sThis(belays[i][0]), sThis(belays[i][1]), belaySize, 0, 2 * Math.PI, false);
                    ctx.fill();
                    ctx.stroke();
                    ctx.closePath();
                }
            }

            // Add the abasail Points
            if (absailPoints === true) {
                for (let i = 0; i < absail.length; i++) {
                    ctx.beginPath();
                    ctx.strokeStyle = decentLine;
                    ctx.fillStyle = decentBelay;
                    ctx.moveTo(sThis(absail[i][0]), sThis(absail[i][1]));
                    ctx.lineTo(sThis(absail[i][2]), sThis(absail[i][3]));
                    ctx.stroke();
                    ctx.closePath();
                    ctx.beginPath();
                    ctx.arc(sThis(absail[i][0]), sThis(absail[i][1]), belaySize, 0, 2 * Math.PI, false);
                    ctx.fill();
                    ctx.stroke();
                    ctx.closePath();
                    var from = new Object();
                    from.x = sThis(absail[i][0]),
                    from.y = sThis(absail[i][1]) + belaySize;
                    var to = new Object();
                    to.x = sThis(absail[i][2]);
                    to.y = sThis(absail[i][3]);
                    drawArrowhead(ctx, from, to, arrowSize, decentLine);
                }
            }
        }

        function sThis(number) {
            return number * scale;
        }

        function drawArrowhead(context, from, to, radius, lineColor) {
            context.beginPath();
            var angle = Math.atan2(to.y - from.y, to.x - from.x)
            var x = radius * Math.cos(angle) + to.x;
            var y = radius * Math.sin(angle) + to.y;
            context.moveTo(x, y);

            angle += (1.0 / 3.0) * (2 * Math.PI)
            x = radius * Math.cos(angle) + to.x;
            y = radius * Math.sin(angle) + to.y;
            context.lineTo(x, y);

            angle += (1.0 / 3.0) * (2 * Math.PI)
            x = radius * Math.cos(angle) + to.x;
            y = radius * Math.sin(angle) + to.y;
            context.lineTo(x, y);

            context.closePath();
            context.fillStyle = lineColor;
            context.fill();
        }

        
        canvas.addEventListener('click', getCursorPosition, false);
        function capture(what) {
            arrayToUpdate = what;
            switch (what) {
                case 'route':
                    route = [];
                    break;
                case 'belay':
                    belays = [];
                    break;
                case 'absail':
                    absail = [];
                    break;
            }
        }

        function getCursorPosition(event) {
            var rect = canvas.getBoundingClientRect();
            var x = event.clientX - rect.left;
            var y = event.clientY - rect.top;
            let tempArray = [];
            switch (arrayToUpdate) {
                case 'route':
                    tempArray.push(parseInt(x.toFixed(1)), parseInt(y.toFixed(1)));
                    route.push(tempArray);
                    break;
                case 'belay':
                    tempArray.push(parseInt(x.toFixed(1)), parseInt(y.toFixed(1)));
                    belays.push(tempArray);
                    break;
                case 'absail':
                    tempAbsail.push(x.toFixed(1), y.toFixed(1));
                    if (tempAbsail.length === 4) {
                        absail.push(tempAbsail);
                        tempAbsail = [];
                    }
                    break;
                
            }
        //    console.log("[" + x.toFixed(1) + ", " + y.toFixed(1) + "] \n");
        }

        img.onload = function () {
            draw();
        }
    </script>
</body>
</html>
