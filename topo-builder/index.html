<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <!-- Styles -->
    <link href="../website/css/style.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Roboto:300" rel="stylesheet" />
    <!-- Scripts-->
    <script src="../website/data/data.js"></script>
    <script>    
        var topoData = {
            "image":"montserrat/crag.jpg",
            "flag":"flags/es.png",
            "title":"Roca Gris > Esparraguera - VS 5a | 190m",
            "belaySize":22,
            "route":[
                [284,2699.3],[267,2534.5],[317,2369.5],[350,2214.5],[400,2052.5],[497,1907.5],[580,1877.5],[612,1782.5],[662,1724.5],[717,1669.5],[712,1599.5],[772,1547.5],[812,1404.5],[847,1407.5],[902,1377.5],[942,1332.5],[962,1249.5],[1015,1089.5],[1025,987.5],[1030,907.5],[1052,832.5],[1085,779.5],[1162,804.5],[1195,804.5],[1237,734.5],[1260,654.5],[1282,589.5],[1377,589.5],[1390,532.5],[1425,407.5],[1465,404.5],[1475,354.5],[1502,334.5],[1525,332.5]
            ],
            "pitches":[{
                "belayPosition":[323,2327],
                "labelPosition":[357,2547],
                "grade":"UIAA IV","height":"30m"
            },{
                "belayPosition":[583,1850],
                "labelPosition":[480,2087],
                "grade":"UIAA V","height":"40m"
            },{
                "belayPosition":[840,1403],
                "labelPosition":[773,1627],
                "grade":"UIAA V+","height":"25m"
            },{
                "belayPosition":[1090,780],
                "labelPosition":[1060,1147],
                "grade":"UIAA IV","height":"50m"
            },{
                "belayPosition":[1390,530],
                "labelPosition":[1307,700],
                "grade":"UIAA IV","height":"20m"
            },{
                "belayPosition":[1517,327],
                "labelPosition":[1510,413],
                "grade":"UIAA IV+","height":"30m"
            }],
            "decent":[{
                "anchor":[null,null],
                "labelPosition":[1810.0, 373.7],
                "path":[[1607,327],[1640,343],[1660,390],[1697,393],[1750,393],[1810,433]],
                "label":"80m"
            },{
                "anchor":[2043,540],
                "labelPosition":[2140,610],
                "path":[[2033.0, 563.7],[2007,640]],"label":"40m"
            },{
                "anchor":[1930.0, 1057.7],
                "labelPosition":[1977,1157],
                "path":[[1927,1087],[1910,1173]],
                "label":"40m"
            },{
                "anchor":[1807,1610],
                "labelPosition":[1867,1787],
                "path":[[1817,1637],[1840,1710]],
                "label":"60m"}
            ]}
    </script>
    <script src="../website/js/topo.js"></script>
    <style>
        *, option {
            font-size: 55px;
        }
        label {
            margin-right:60px;
        }
        button{
           color:#FFFFFF;
            border:0;
            padding:.4rem 1.5rem;
            font-size: 40px; 
        }
        .safe{
            background-color: #4CAF50;
        }
        .danger{
            background-color: #f44336;
        }
        .black {
            background-color: #111111;
        }
        .short{
            width:6rem;
        }
        .long{
            width:100%;
        }
        input{
            font-size:0.8rem;
        }
    </style>
</head>
<body>
    <fieldset>
        <label><input type="checkbox" value="infoBox" checked id="c1" onclick="draw();" />Info Box</label>
        <label><input type="checkbox" value="routeLine" checked id="c2" onclick="draw();" />Route</label>
        <label><input type="checkbox" value="belays" checked id="c3" onclick="draw();" />Belay Points</label>
        <label><input type="checkbox" value="absail" checked id="c4" onclick="draw();" />Approch / Decent</label>
        <label><input type="checkbox" value="labels" checked id="c5" onclick="draw();" />Labels</label>
        <br />
        <label><input type="radio" value="max" checked name="scale" />Maximum size</label>
        <label><input type="radio" value="2160" name="scale" />Big 2160w</label>
        <label><input type="radio" value="1600" name="scale" />Medium  1600w</label>
        <label><input type="radio" value="840" name="scale" />Small 840w</label>
        <br />
        <button onclick="draw()" class="black">Re-Draw Topo</button>
    </fieldset>
    <canvas id="canvas" width="2800" height="2800"></canvas>

    <section style="float:right;margin:30px;">
        <h1>Build A Topo</h1>
        <p>Use this tool to make consistent topo images for the site or for social media.</p>
        <h2>Select Climb</h2>
        <p>Add the crag image into the scource code then select what climb it is for.</p>
        <fieldset id="selectHolder"></fieldset>
        <h2>Route</h2>
        <fieldset>
            <label><input type="radio" value="rt" checked name="what" />Route </label>
            <input type="text"  value="" id="routeOutput" class="long"/><br />
            <button onclick="draw();" class="safe">Update Route</button>
            <button onclick="topoData.route = [];document.getElementById('routeOutput').value = '';draw();" class="danger">Remove Route</button>
            
        </fieldset>
        <h2>Pitches</h2>
        <fieldset id="pitchOutput">
            <label><input type="radio" value="lp" name="what" />Label Position</label>
            <input type="text"  value="" id="labelPositionX" class="short" /><input type="text" class="short" value="" id="labelPositionY"/><br />
            <label><input type="radio" value="bp" name="what" />Belay Position</label>
            <input type="text"  value="" id="belayPositionX" class="short" /><input type="text"  class="short" value="" id="belayPositionY"/><br />
            <label><input type="radio" value="" name="what" />Height</label>
            <input type="text"  value="" id="height"/><br />
            <label><input type="radio" value="" name="what" />Grade</label>
            <input type="text"  value="" id="grade"/><br />
            <button onclick="pushPitch();" class="safe">Add Pitch</button> 
            <button onclick="topoData.pitches = [];draw();" class="danger">Remove All Pitches</button> 
        </fieldset>
        <h2>Approch & Decent</h2>
        <fieldset>
            <label><input type="radio" value="dlp" name="what" />Label Position</label>
            <input type="text"  value="" id="dLabelPositionX" class="short" /><input type="text"  class="short" value="" id="dLabelPositionY"/><br />
            <label><input type="radio" value="dbp" name="what" />Belay Position</label>
            <input type="text"  value="" id="dBelayPositionX" class="short" /><input type="text"  class="short" value="" id="dBelayPositionY"/><br />
            <label><input type="radio" value="dr" name="what" />Path</label>
            <input type="text"  value="" id="decentRoute" class="long"/><br />
            <label><input type="radio" value="" name="what" />Label</label>
            <input type="text"  value="" id="label"/><br />
            <button onclick="pushDecent();" class="safe">Add Decent</button> 
            <button onclick="topoData.decent = [];draw();" class="danger">Demove All Decent Info</button> 
        </fieldset>
        <h2>Belay Size</h2>
        <fieldset>
            <label><input type="text" value="24" name="belaySize" id="belaySize" />Belay Size</label>
            <button onclick="topoData.belaySize = parseInt(document.getElementById('belaySize').value);draw();" class="safe">Update Belay Size</button> 
        </fieldset>
        <h2>Raw JSON</h2>
        <fieldset>
            <button class="black" onclick="document.getElementById('rawOutput').value = JSON.stringify(topoData);">Publish</button>
            <textarea id="rawOutput" style="max-width:100%;min-height:300px;"></textarea>
        </fieldset>

    </section>
    <br />
    <br />
    <script>
        var canvas = document.getElementById('canvas');
        /** MAKE A DROP DOWN WITH A LIST OF ALL CLIMBS **/
        var selectHolder = document.getElementById("selectHolder");
        var selectList = document.createElement("select");
        if(topoData.belaySize){
            document.getElementById('belaySize').value = topoData.belaySize;
        }
        const climbsArr = climbsData.climbs;
        selectList.setAttribute("id", "climbList");
        selectList.setAttribute("name", "climbList");
        selectHolder.appendChild(selectList);
        for (let i = 0; i < climbsArr.length; i++) {
            var option = document.createElement("option");
            option.setAttribute("value", climbsArr[i].id);
            option.text = climbsArr[i].cliff;
            selectList.appendChild(option);
        }

        /** BUILDER STEP 1 - GET CLIMB DETAILS **/
        document.addEventListener('DOMContentLoaded', function () {
            document.querySelector('select[name="climbList"]').onchange = changeEventHandler;
        }, false);
        var mapping = {
            'england': 'gb.png', 'scotland': 'gb.png', 'wales': 'gb.png', 'ireland': 'ie.png', 'spain': 'es.png', 'portugal': 'pt.png',
            'italy': 'it.png', 'usa': 'us.png', 'norway': 'no.png', 'canada': 'ca.png', 'hongkong': 'cn.png', 'greece': 'gr.png',
            'france': 'fr.png', 'switzerland': 'ch.png'
        }; // base 64 images from the css as vectors on canvas don't play nice :(
        function changeEventHandler(event) {
            if (event.target.value) {
                var climb = climbsArr.find(climb => climb.id == event.target.value); // get the single climb object
                topoData.flag = 'flags/' + mapping[climb.flag];
                flag.src = topoData.flag;
                topoData.title = climb.cliff + " > " + climb.routeName + " | " + climb.tradGrade + " " + climb.techGrade + " - " + climb.length + "m";
                draw();
            }
        }

        canvas.addEventListener('click', getCursorPosition, false);
        var tempArray = [];
        var decentPath = [];
        const labelPositionX = document.getElementById('labelPositionX');
        const labelPositionY = document.getElementById('labelPositionY');
        const belayPositionX = document.getElementById('belayPositionX');
        const belayPositionY = document.getElementById('belayPositionY');
        const dLabelPositionX = document.getElementById('dLabelPositionX');
        const dLabelPositionY = document.getElementById('dLabelPositionY');
        const dBelayPositionX = document.getElementById('dBelayPositionX');
        const dBelayPositionY = document.getElementById('dBelayPositionY');
        const decentRoute = document.getElementById('decentRoute');
        const pitchGrade = document.getElementById('grade');
        const pitchHeight = document.getElementById('height');
        const label = document.getElementById('label');

        function getCursorPosition(event) {
            var rect = canvas.getBoundingClientRect();
            var x = event.clientX - rect.left;
            var y = event.clientY - rect.top;
            var what = getRadioValue();
            switch(what){
                case'rt':
                    document.getElementById('routeOutput').value += 
                    "[" + x.toFixed(1) + ", " + y.toFixed(1) + "] ";
                    tempArray.push(parseInt(x.toFixed(1)), parseInt(y.toFixed(1)));
                    topoData.route.push(tempArray);
                    tempArray = [];
                    break;
                case'lp':
                    labelPositionX.value = x.toFixed(1);
                    labelPositionY.value = y.toFixed(1);
                    break;
                case'bp':
                    belayPositionX.value = x.toFixed(1);
                    belayPositionY.value = y.toFixed(1);
                    break;
                case'dlp':
                    dLabelPositionX.value = x.toFixed(1);
                    dLabelPositionY.value = y.toFixed(1);
                    break;
                case'dbp':
                    dBelayPositionX.value = x.toFixed(1);
                    dBelayPositionY.value = y.toFixed(1);
                    break;
                case'dr':
                    let decentTempArray = [];
                    document.getElementById('decentRoute').value += 
                    "[" + x.toFixed(1) + ", " + y.toFixed(1) + "] ";
                    decentTempArray.push(parseInt(x.toFixed(1)), parseInt(y.toFixed(1)));
                    decentPath.push(decentTempArray);
                    break;
            }
        }

        function pushPitch(){
            let tempPitch;
            let tempLabelPosition = [];
            let tempBelayPosition = [];
            tempLabelPosition.push(parseInt(labelPositionX.value), parseInt(labelPositionY.value));
            tempBelayPosition.push(parseInt(belayPositionX.value), parseInt(belayPositionY.value));
            tempPitch = new Pitch(tempBelayPosition, tempLabelPosition, pitchGrade.value, pitchHeight.value);
            topoData.pitches.push(tempPitch);
            labelPositionX.value = '';
            labelPositionY.value = '';
            belayPositionX.value = '';
            belayPositionY.value = '';
            pitchGrade.value = '';
            pitchHeight.value = '';
            draw();
        }

        function pushDecent(){
            let tempDecent;
            let tempLabelPosition = [];
            let tempBelayPosition = [];
            tempLabelPosition.push(parseInt(dLabelPositionX.value), parseInt(dLabelPositionY.value));
            tempBelayPosition.push(parseInt(dBelayPositionX.value), parseInt(dBelayPositionY.value));
            tempDecent = new Decent(tempBelayPosition, tempLabelPosition, decentPath, label.value);
            topoData.decent.push(tempDecent);
            dLabelPositionX.value = '';
            dLabelPositionY.value = '';
            dBelayPositionX.value = '';
            dBelayPositionY.value = '';
            label.value = '';
            decentRoute.value = '';
            decentPath = [];
            draw();
        }
        
        const radios = document.getElementsByName("what");

        function getRadioValue (){
            for (let i = 0; i < radios.length; i++) {
                if (radios[i].checked) {
                    return radios[i].value;              
                }
            }
        }


        /** CONSTRUCTION OF JSON **/
        function Pitch (belayPosition,labelPosition, grade, height){
            this.belayPosition = belayPosition;
            this.labelPosition = labelPosition;
            this.grade = grade;
            this.height = height;
        }

        function Decent (belayPosition, labelPosition, route, label){
            this.anchor = belayPosition;
            this.labelPosition = labelPosition;
            this.path = route;
            this.label = label;
        }
    </script>
</body>
</html>